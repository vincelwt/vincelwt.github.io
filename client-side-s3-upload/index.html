<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

	<title>Client-side S3 file(s) uploading</title>

	<meta name="HandheldFriendly" content="True" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<link rel="stylesheet" type="text/css" href="../assets/css/style.css?v=a12a03c789" />

	<link rel="shortcut icon" href="../favicon.png" type="image/png" />
    <link rel="canonical" href="index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="amp/index.html" />
    
    <meta property="og:site_name" content="Hi, I&#x27;m Vince" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Client-side S3 file(s) uploading" />
    <meta property="og:description" content="Your servers need to take a break" />
    <meta property="og:url" content="http://localhost:2368/client-side-s3-upload/" />
    <meta property="article:published_time" content="2018-06-13T10:52:00.000Z" />
    <meta property="article:modified_time" content="2018-12-21T14:14:28.000Z" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Client-side S3 file(s) uploading" />
    <meta name="twitter:description" content="Your servers need to take a break" />
    <meta name="twitter:url" content="http://localhost:2368/client-side-s3-upload/" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Vincent" />
    <meta name="twitter:site" content="@vincelwt" />
    <meta name="twitter:creator" content="@vincelwt" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Hi, I&#x27;m Vince",
        "logo": {
            "@type": "ImageObject",
            "url": "http://localhost:2368/content/images/2018/12/logo-1.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Vincent",
        "image": {
            "@type": "ImageObject",
            "url": "http://localhost:2368/content/images/2019/01/unabomber.png",
            "width": 550,
            "height": 550
        },
        "url": "http://localhost:2368/author/vince/",
        "sameAs": [
            "https://twitter.com/vincelwt"
        ]
    },
    "headline": "Client-side S3 file(s) uploading",
    "url": "http://localhost:2368/client-side-s3-upload/",
    "datePublished": "2018-06-13T10:52:00.000Z",
    "dateModified": "2018-12-21T14:14:28.000Z",
    "description": "Your servers need to take a break",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://localhost:2368/"
    }
}
    </script>

    <script src="../public/ghost-sdk.js?v=a12a03c789"></script>
<script>
ghost.init({
	clientId: "ghost-frontend",
	clientSecret: "71159466bd71"
});
</script>
    <meta name="generator" content="Ghost 2.9" />
    <link rel="alternate" type="application/rss+xml" title="Hi, I&#x27;m Vince" href="../rss/index.html" />
</head>

<body class="post-template">

	<nav id="menu">
	<a class="close-button">Close</a>
	<div class="nav-wrapper">
		<p class="nav-label">Menu</p>
		<ul>
			<li class="nav-home" role="presentation"><a href="../index.html">Home</a></li>
			<li class="nav-twitter"><a href="https://twitter.com/vincelwt" title="@vincelwt"><i class="ic ic-twitter"></i> Twitter</a></li>
			<li class="nav-subscribe"><a href="../subscribe/index.html"><i class="ic ic-mail"></i> Subscribe</a></li>
		</ul>
	</div>
</nav>


	<section id="wrapper">
		<a class="hidden-close"></a>
		

<div class="progress-container">
	<span class="progress-bar"></span>
</div>

<header id="post-header">
	<div class="inner">
		<nav id="navigation">
			<span class="blog-logo">
				<a href="../index.html"><img src="../content/images/2018/12/logo-1.png" alt="Blog Logo" /></a>
			</span>
			<!--<span id="menu-button" class="nav-button">
				<a class="menu-button"><i class="ic ic-menu"></i> Menu</a>
			</span>-->
		</nav>
		<h1 class="post-title">Client-side S3 file(s) uploading</h1>
		<span class="post-meta"><a href="../author/vince/index.html">Vincent</a> | <time datetime="2018-06-13">13 Jun 2018</time></span>
		
	</div>
</header>

<main class="content" role="main">
	<article class="post">
		<div class="inner">

			<section class="post-content">
				<p>We'll see how to upload a static file on Amazon S3 without consuming server bandwidth.</p><p>This can be quite useful in a serverless architecture, to prevent dealing with the AWS API Gateway's weird support of binary files. Or in general, to decrease your server loads and increase uploading speed.</p><p>It works by asking our server to get a signed upload URL from S3 and then uploading the file(s) directly to it.</p><h2 id="aws-side">AWS side</h2><p>Create a bucket on S3 and give it public read rights.</p><p>Replace the bucket's <em>CORS configuration</em> with the following:</p><pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;CORSConfiguration xmlns="http://s3.amazonaws.com/doc/2006-03-01/"&gt;
&lt;CORSRule&gt;
	&lt;AllowedOrigin&gt;*&lt;/AllowedOrigin&gt;
	&lt;AllowedMethod&gt;GET&lt;/AllowedMethod&gt;
	&lt;AllowedMethod&gt;POST&lt;/AllowedMethod&gt;
	&lt;AllowedMethod&gt;PUT&lt;/AllowedMethod&gt;
	&lt;MaxAgeSeconds&gt;3000&lt;/MaxAgeSeconds&gt;
	&lt;AllowedHeader&gt;*&lt;/AllowedHeader&gt;
&lt;/CORSRule&gt;
&lt;/CORSConfiguration&gt;
</code></pre><h2 id="server-side">Server side</h2><pre><code>const AWS = require('aws-sdk')

let s3 = new AWS.S3()

app.post('/s3uploadurl', (req, res, next) =&gt; {

	let s3Params = {
		Bucket: 'my-dope-bucket',
		Key: req.body.name,
		ContentType: req.body.type,
		ACL: 'public-read'
	}

	let uploadURL = s3.getSignedUrl('putObject', s3Params);

	res.send({
		uploadURL: uploadURL
	})
})
</code></pre><h2 id="client-side">Client side</h2><p>In our example we use JQuery, but everything is easily replaceable with pure JS (using <strong>fetch</strong> for ajax call)</p><pre><code>&lt;form action='/whatever'&gt;
	&lt;!-- File selector, once we select files, they'll be automatically uploaded to s3 --&gt;
	&lt;input type="file"/&gt;

	&lt;!-- myFile will contain the URL of the file hosted on S3 --&gt;
	&lt;input type="hidden" name="myFile" value=""&gt;
&lt;/form&gt;

&lt;script&gt;
let s3baseUrl = 'https://s3.eu-west-3.amazonaws.com/my-dope-bucket/' // CHANGE WITH YOUR OWN BUCKET AND REGION

let inputElement = $("form input[type='file']")[0]
inputElement.onchange = function(event) {
	let file = inputElement.files[0]

	let reader = new FileReader()
	reader.addEventListener('loadend', function(e){
		// $('.spinner').show() // Optional, if you have a spinner, now is a good time to show it

		$.ajax({
			type: 'POST',
			url: "/s3uploadurl",
			data: {
				name: file.name,
				type: file.type
			},
			success: function(result) {
				$.ajax({
					url: result.uploadURL,
					type: 'PUT',
					data: new Blob([reader.result], {type: file.type}),
					processData: false,
					contentType: false,
					success: function(result) {
						// $('.spinner').hide() // Hide the spinner
					
						$('[name="myFile"]').val(s3baseUrl + file.name)
					}
				})
			}
		})
	})

	reader.readAsArrayBuffer(file)
}
&lt;/script&gt;
</code></pre>
			</section>

			<section class="post-info">

				<div class="post-share">
					<a class="twitter" href="https://twitter.com/share?text=Client-side S3 file(s) uploading&url=http://localhost:2368/client-side-s3-upload/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
						<i class="ic ic-twitter"></i><span class="hidden">Twitter</span>
					</a>
					<a class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:2368/client-side-s3-upload/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
						<i class="ic ic-facebook"></i><span class="hidden">Facebook</span>
					</a>
					<div class="clear"></div>
				</div>

				<aside class="post-tags">
					
				</aside>

				<div class="clear"></div>

						<aside class="post-author">
							<figure class="post-author-avatar avatar">
									<img src="../content/images/2019/01/unabomber.png" alt="Vincent" />
							</figure>
							<div class="post-author-bio">
								<h4 class="post-author-name"><a href="../author/vince/index.html">Vincent</a></h4>
									<span class="post-author-location"><i class="ic ic-location"></i> On a beach somewhere</span>
									<span class="post-author-twitter"><i class="ic ic-twitter"></i> <a target="_blank" href="https://twitter.com/@vincelwt">Twitter</a></span>
							</div>
							<div class="clear"></div>
						</aside>

			</section>


			<!--<section class="post-comments">
				<a id="show-disqus" class="post-comments-activate">Show Comments</a>
			    <div id="disqus_thread"></div>
			</section>-->

            <section class="post-subscribe">
                <form method="post" action="../subscribe/index.html" id="" class="post-subscribe-form">
    <input class="confirm" type="hidden" name="confirm"  /><input class="location" type="hidden" name="location"  /><input class="referrer" type="hidden" name="referrer"  />

    <div class="form-group">
        <input class="post-subscribe-input" type="email" name="email" placeholder="Your email address" />
    </div>
    <button id="" class="post-subscribe-button" type="submit"><span>Subscribe</span></button>
    
<script>
    (function(g,h,o,s,t){
        var buster = function(b,m) {
            h[o]('input.'+b).forEach(function (i) {
                i.value=i.value || m;
            });
        };
        buster('location', g.location.href);
        buster('referrer', h.referrer);
    })(window,document,'querySelectorAll','value');
</script>

</form>


                <p>Get the latest posts delivered right to your inbox.</p>
            </section>

			<aside class="post-nav">
					<a class="post-nav-next" href="../looking-for-cofounder/index.html">
						<section class="post-nav-teaser">
							<i class="ic ic-arrow-left"></i>
							<h2 class="post-nav-title">Looking for a co-conspirator</h2>
							<p class="post-nav-excerpt">Or just co-founder.&hellip;</p>
						</section>
					</a>
					<a class="post-nav-prev" href="../optimize-your-electron-app-startup-time/index.html">
						<section class="post-nav-teaser">
							<i class="ic ic-arrow-right"></i>
							<h2 class="post-nav-title">Electron: optimize app startup time</h2>
							<p class="post-nav-excerpt">Make your app open terribly faster.&hellip;</p>
						</section>
					</a>
				<div class="clear"></div>
			</aside>


		</div>
	</article>
</main>


		<div id="body-class" style="display: none;" class="post-template"></div>

		<!--<footer id="footer">
			<div class="inner">
				<section class="credits">
					<span class="credits-theme">Theme <a href="https://github.com/zutrinken/attila">Attila</a> by <a href="http://zutrinken.com" rel="nofollow">zutrinken</a></span>
					<span class="credits-software">Published with <a href="http://ghost.org">Ghost</a></span>
				</section>
			</div>
		</footer>-->
	</section>
	<script src="../assets/js/highlight.pack.js?v=a12a03c789"></script>
	<script>hljs.initHighlightingOnLoad();</script>

	<!--<script type="text/javascript" src="/assets/js/script.js?v=a12a03c789"></script>-->

	<script>
  (function(a,b,c){var d=a.history,e=document,f=navigator||{},g=localStorage,
  h=encodeURIComponent,i=d.pushState,k=function(){return Math.random().toString(36)},
  l=function(){return g.cid||(g.cid=k()),g.cid},m=function(r){var s=[];for(var t in r)
  r.hasOwnProperty(t)&&void 0!==r[t]&&s.push(h(t)+"="+h(r[t]));return s.join("&")},
  n=function(r,s,t,u,v,w,x){var z="https://www.google-analytics.com/collect",
  A=m({v:"1",ds:"web",aip:c.anonymizeIp?1:void 0,tid:b,cid:l(),t:r||"pageview",
  sd:c.colorDepth&&screen.colorDepth?screen.colorDepth+"-bits":void 0,dr:e.referrer||
  void 0,dt:e.title,dl:e.location.origin+e.location.pathname+e.location.search,ul:c.language?
  (f.language||"").toLowerCase():void 0,de:c.characterSet?e.characterSet:void 0,
  sr:c.screenSize?(a.screen||{}).width+"x"+(a.screen||{}).height:void 0,vp:c.screenSize&&
  a.visualViewport?(a.visualViewport||{}).width+"x"+(a.visualViewport||{}).height:void 0,
  ec:s||void 0,ea:t||void 0,el:u||void 0,ev:v||void 0,exd:w||void 0,exf:"undefined"!=typeof x&&
  !1==!!x?0:void 0});if(f.sendBeacon)f.sendBeacon(z,A);else{var y=new XMLHttpRequest;
  y.open("POST",z,!0),y.send(A)}};d.pushState=function(r){return"function"==typeof d.onpushstate&&
  d.onpushstate({state:r}),setTimeout(n,c.delay||10),i.apply(d,arguments)},n(),
  a.ma={trackEvent:function o(r,s,t,u){return n("event",r,s,t,u)},
  trackException:function q(r,s){return n("exception",null,null,null,null,r,s)}}})
  (window,"UA-98677497-1",{anonymizeIp:true,colorDepth:true,characterSet:true,screenSize:true,language:true});
</script>

</body>
</html>
